<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ•™æç”Ÿæˆç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- Navigation Bar -->
    <nav class="bg-white border-b border-gray-100 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center">
                    <span class="text-2xl mr-2">ğŸ“</span>
                    <span class="font-bold text-xl text-gray-900 tracking-tight">AI æ•™æç”Ÿæˆç³»çµ±</span>
                </div>
                <div class="flex items-center space-x-4">
                    {% if user %}
                    <div class="flex items-center bg-gray-50 rounded-full pl-1 pr-4 py-1 border border-gray-100">
                        <img src="{{ user.picture }}" class="w-8 h-8 rounded-full border border-white" alt="Avatar">
                        <div class="ml-2">
                            <p class="text-xs font-semibold text-gray-800">{{ user.name }}</p>
                            <p class="text-[10px] text-gray-500">{{ "ç®¡ç†å“¡" if is_admin else "ä¸€èˆ¬ç”¨æˆ¶" }}</p>
                        </div>
                    </div>
                    <a href="/logout" class="text-sm text-gray-500 hover:text-red-600 transition">ç™»å‡º</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Announcements Section -->
        {% if announcements %}
        <div class="mb-8 bg-blue-50 border border-blue-100 rounded-2xl p-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-4 opacity-10">
                <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 20 20">
                    <path
                        d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z">
                    </path>
                </svg>
            </div>
            <h2 class="text-blue-800 font-bold mb-3 flex items-center">
                <span class="mr-2">ğŸ“¢</span> æœ€æ–°å…¬å‘Š
            </h2>
            <div class="space-y-3">
                {% for ann in announcements %}
                <div class="flex justify-between items-start">
                    <p class="text-blue-700 text-sm">{{ ann.content }}</p>
                    <span class="text-[10px] text-blue-400 whitespace-nowrap ml-4">{{
                        ann.created_at.strftime('%Y-%m-%d') }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Tabs Navigation -->
        <div class="flex space-x-1 mb-8 bg-white p-1 rounded-2xl border border-gray-100 shadow-sm overflow-x-auto">
            <button onclick="switchTab('library')" id="tab-library"
                class="flex-1 py-3 px-6 rounded-xl font-bold transition flex items-center justify-center whitespace-nowrap bg-indigo-600 text-white shadow-lg">
                ğŸ“š æ•™æåº«
            </button>
            {% if is_admin %}
            <button onclick="switchTab('create')" id="tab-create"
                class="flex-1 py-3 px-6 rounded-xl font-bold transition flex items-center justify-center whitespace-nowrap text-gray-500 hover:bg-gray-50">
                âœ¨ è£½ä½œæ–°æ•™æ
            </button>
            <button onclick="switchTab('admin')" id="tab-admin"
                class="flex-1 py-3 px-6 rounded-xl font-bold transition flex items-center justify-center whitespace-nowrap text-gray-500 hover:bg-gray-50">
                âš™ï¸ ç³»çµ±ç®¡ç†
            </button>
            {% endif %}
        </div>

        <!-- Tab: Library -->
        <section id="view-library" class="block">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">æ•™æç¸½è¦½</h2>
                <button onclick="loadReports()" class="p-2 hover:bg-gray-100 rounded-full transition text-gray-500"
                    title="é‡æ–°æ•´ç†">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                        </path>
                    </svg>
                </button>
            </div>
            <div id="reports-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div
                    class="text-center col-span-full py-12 text-gray-500 bg-white rounded-3xl border border-dashed border-gray-200">
                    è¼‰å…¥ä¸­...
                </div>
            </div>
        </section>

        <!-- Tab: Create -->
        {% if is_admin %}
        <section id="view-create" class="hidden">
            <div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-8 max-w-2xl mx-auto">
                <h2 class="text-2xl font-bold text-gray-800 mb-8 border-b border-gray-50 pb-4 flex items-center">
                    <span class="mr-2">âœ¨</span> è£½ä½œæ–°æ•™æ
                </h2>

                <div class="space-y-8">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-4">1. é¸æ“‡å½±ç‰‡ä¾†æº</label>
                        <div id="drop-zone"
                            class="mb-4 p-8 border-2 border-dashed border-gray-200 rounded-2xl text-center hover:bg-indigo-50/30 hover:border-indigo-200 transition-all cursor-pointer relative group">
                            <input type="file" id="file-input" class="hidden" accept=".mp4,.mkv,.mov,.avi">
                            <div id="upload-text">
                                <div
                                    class="w-12 h-12 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                                    <svg class="w-6 h-6 text-indigo-500" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 4v16m8-8H4"></path>
                                    </svg>
                                </div>
                                <p class="text-gray-600 font-medium">æ‹–æ›³å½±ç‰‡è‡³æ­¤æˆ–æ˜¯ <span class="text-indigo-600">é»é¸ä¸Šå‚³</span>
                                </p>
                                <p class="text-xs text-gray-400 mt-2">æ”¯æ´ MP4, MKV, MOV, AVI</p>
                            </div>
                            <div id="upload-progress"
                                class="hidden absolute inset-0 bg-white/90 rounded-2xl flex flex-col justify-center items-center p-8">
                                <p class="text-indigo-600 font-bold mb-4">æ­£åœ¨ä¸Šå‚³å½±ç‰‡...</p>
                                <div class="w-full bg-gray-100 rounded-full h-3 overflow-hidden">
                                    <div class="bg-indigo-600 h-full rounded-full transition-all duration-300"
                                        style="width: 100%"></div>
                                </div>
                            </div>
                        </div>
                        <select id="video-select"
                            class="w-full p-4 bg-gray-50 border-none rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none text-gray-700 font-medium">
                            <option value="">æ­£åœ¨è¼‰å…¥å½±ç‰‡...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-4">2. é¸æ“‡ AI æ¨¡å‹</label>
                        <div class="grid grid-cols-2 gap-4">
                            <label class="cursor-pointer">
                                <input type="radio" name="model" value="mistral" class="peer sr-only" checked>
                                <div
                                    class="p-4 rounded-2xl border border-gray-100 peer-checked:border-indigo-500 peer-checked:bg-indigo-50 transition-all text-center hover:bg-gray-50 shadow-sm peer-checked:shadow-md">
                                    <div class="font-bold text-gray-800">Mistral AI</div>
                                    <div
                                        class="text-[10px] text-indigo-500 font-semibold uppercase tracking-wider mt-1">
                                        å¹³è¡¡å‹</div>
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="model" value="groq" class="peer sr-only">
                                <div
                                    class="p-4 rounded-2xl border border-gray-100 peer-checked:border-red-500 peer-checked:bg-red-50 transition-all text-center hover:bg-gray-50 shadow-sm peer-checked:shadow-md">
                                    <div class="font-bold text-gray-800">Groq (Llama 3)</div>
                                    <div class="text-[10px] text-red-500 font-semibold uppercase tracking-wider mt-1">
                                        æ¥µé€Ÿå‹</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <button onclick="submitJob()" id="btn-submit"
                        class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-2xl shadow-lg hover:shadow-indigo-200 transition-all transform active:scale-[0.98] disabled:opacity-50">
                        ğŸš€ é–‹å§‹ç”Ÿæˆæ•™æ
                    </button>
                    <div id="status-msg" class="hidden p-4 rounded-2xl text-center text-sm font-medium"></div>
                </div>
            </div>
        </section>

        <!-- Tab: Admin Console -->
        <section id="view-admin" class="hidden space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Announcement Manager -->
                <div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-8">
                    <h3 class="text-xl font-bold mb-6 text-gray-800 flex items-center">
                        <span class="mr-2">ğŸ“¢</span> å…¬å‘Šç®¡ç†
                    </h3>
                    <div class="space-y-4">
                        <textarea id="announcement-content"
                            class="w-full rounded-2xl border-gray-100 bg-gray-50 focus:ring-2 focus:ring-indigo-500 focus:bg-white p-4 text-sm transition-all"
                            rows="3" placeholder="è¼¸å…¥å…¬å‘Šå…§å®¹..."></textarea>
                        <button onclick="addAnnouncement()"
                            class="w-full bg-gray-900 text-white font-bold py-3.5 rounded-2xl hover:bg-black transition-all">
                            ç™¼ä½ˆæ–°å…¬å‘Š
                        </button>
                    </div>
                    <div id="announcement-admin-list" class="mt-8 space-y-4">
                        <!-- Announced will be populated here -->
                    </div>
                </div>

                <!-- System Info -->
                <div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-8">
                    <h3 class="text-xl font-bold mb-6 text-gray-800 flex items-center">
                        <span class="mr-2">ğŸ“Š</span> ç³»çµ±ç‹€æ…‹
                    </h3>
                    <div class="space-y-4 text-sm">
                        <div class="flex justify-between py-3 border-b border-gray-50">
                            <span class="text-gray-500">ç•¶å‰è§’è‰²</span>
                            <span class="font-bold text-indigo-600">ç®¡ç†å“¡</span>
                        </div>
                        <div class="flex justify-between py-3 border-b border-gray-50">
                            <span class="text-gray-500">å·²å•Ÿç”¨æ ¸å¿ƒ</span>
                            <span class="text-gray-700 font-medium">Mistral + Groq</span>
                        </div>
                        <div class="flex justify-between py-3">
                            <span class="text-gray-500">ä¼ºæœå™¨æ™‚é–“</span>
                            <span class="text-gray-400" id="server-time">è¼‰å…¥ä¸­...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quiz Results Table -->
            <div class="bg-white rounded-3xl shadow-sm border border-gray-100 p-8">
                <h3 class="text-xl font-bold mb-6 text-gray-800 flex items-center">
                    <span class="mr-2">ğŸ“</span> æœ€è¿‘æ¸¬é©—æˆç¸¾
                </h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-100">
                        <thead>
                            <tr>
                                <th
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">
                                    ç”¨æˆ¶</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">
                                    æ•™æå½±ç‰‡</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">
                                    å¾—åˆ†</th>
                                <th
                                    class="px-6 py-4 text-left text-xs font-bold text-gray-400 uppercase tracking-wider">
                                    æ™‚é–“</th>
                            </tr>
                        </thead>
                        <tbody id="quiz-results-list" class="bg-white divide-y divide-gray-50 text-sm italic">
                            <tr>
                                <td colspan="4" class="px-6 py-12 text-center text-gray-400">æ­£åœ¨ç²å–æ•¸æ“š...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        {% endif %}
    </div>

    <script>
        const isAdmin = {{ "true" if is_admin else "false" }};

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadReports();
            if (isAdmin) {
                loadVideos();
                setupUpload();
                setInterval(() => {
                    document.getElementById('server-time').innerText = new Date().toLocaleTimeString();
                }, 1000);
            }

            // Polling reports
            setInterval(() => {
                const libraryVisible = !document.getElementById('view-library').classList.contains('hidden');
                if (libraryVisible) loadReports(true);
            }, 5000);
        });

        function switchTab(tab) {
            const tabs = isAdmin ? ['library', 'create', 'admin'] : ['library'];
            tabs.forEach(t => {
                const view = document.getElementById(`view-${t}`);
                if (view) view.classList.add('hidden');

                const btn = document.getElementById(`tab-${t}`);
                if (btn) {
                    btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg');
                    btn.classList.add('text-gray-500', 'hover:bg-gray-50');
                }
            });

            document.getElementById(`view-${tab}`).classList.remove('hidden');
            const activeBtn = document.getElementById(`tab-${tab}`);
            activeBtn.classList.remove('text-gray-500', 'hover:bg-gray-50');
            activeBtn.classList.add('bg-indigo-600', 'text-white', 'shadow-lg');

            if (tab === 'admin') loadAdminData();
            if (tab === 'library') loadReports();
        }

        async function loadReports(isBackground = false) {
            const container = document.getElementById('reports-list');
            if (!isBackground) {
                container.innerHTML = '<div class="text-center col-span-full py-12 text-gray-400">è¼‰å…¥ä¸­...</div>';
            }

            try {
                const res = await fetch('/api/reports');
                if (res.status === 401) { window.location.reload(); return; }
                const reports = await res.json();

                container.innerHTML = '';
                if (reports.length === 0) {
                    container.innerHTML = '<div class="text-center col-span-full py-12 text-gray-400 bg-white rounded-3xl border border-dashed border-gray-100">ç›®å‰æš«ç„¡æ•™æ</div>';
                    return;
                }

                reports.forEach(r => {
                    const isProcessing = r.status === 'processing';
                    let dateStr = new Date(r.timestamp * 1000).toLocaleString('zh-TW', { hour12: false });
                    if (isProcessing) dateStr = 'è™•ç†ä¸­...';

                    const isGroq = r.model.includes('Groq');
                    const badgeClass = isGroq ? 'bg-red-50 text-red-600 border-red-100' : 'bg-indigo-50 text-indigo-600 border-indigo-100';

                    let cardContent = '';
                    let cardOnClick = '';
                    let cursorClass = '';

                    if (isProcessing) {
                        cursorClass = 'cursor-default opacity-70';
                        cardContent = `
                            <div class="mt-4 flex justify-center items-center py-3 bg-gray-50 text-gray-400 rounded-xl text-xs font-medium border border-gray-100">
                                <svg class="animate-spin h-4 w-4 mr-2 text-indigo-500" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                æ­£åœ¨åˆ†æç”Ÿæˆä¸­...
                            </div>
                        `;
                    } else {
                        cursorClass = 'cursor-pointer hover:shadow-xl hover:border-indigo-100 group';
                        cardOnClick = `onclick="window.open('${r.report_url}', '_blank')"`;

                        const showQuiz = r.quiz_url && !isGroq;
                        if (showQuiz) {
                            cardContent = `
                                <div class="mt-6 pt-4 border-t border-gray-50">
                                    <button onclick="event.stopPropagation(); window.open('${r.quiz_url}', '_blank')" class="w-full text-center py-2.5 bg-indigo-50 hover:bg-indigo-600 hover:text-white text-indigo-600 rounded-xl text-xs font-bold transition-all border border-indigo-100 flex items-center justify-center">
                                        ğŸ“ é€²å…¥äº’å‹•æ¸¬é©—
                                    </button>
                                </div>
                            `;
                        } else {
                            cardContent = `
                                <div class="mt-6 text-right">
                                    <span class="text-[10px] uppercase font-bold text-gray-300 group-hover:text-indigo-500 transition-all">é»æ“ŠæŸ¥çœ‹æ•™æå…¨æ–‡ &rarr;</span>
                                </div>
                            `;
                        }
                    }

                    const card = `
                        <div ${cardOnClick} class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden transition-all duration-300 ${cursorClass} flex flex-col justify-between p-6">
                            <div>
                                <div class="flex justify-between items-start mb-4">
                                    <span class="text-[10px] font-bold px-2 py-1 rounded-lg border ${badgeClass}">${r.model}</span>
                                    <span class="text-[10px] text-gray-400 font-medium">${dateStr}</span>
                                </div>
                                <h3 class="font-bold text-gray-800 text-lg mb-2 line-clamp-2 group-hover:text-indigo-600 transition-colors" title="${r.video_name}">${r.video_name}</h3>
                            </div>
                            
                            <div>
                                ${cardContent}
                                ${isAdmin && !isProcessing ? `
                                <div class="mt-4 pt-3 flex justify-end">
                                    <button onclick="event.stopPropagation(); deleteReport('${r.model_key}', '${r.video_name}')" class="text-[10px] font-bold text-red-300 hover:text-red-600 transition-colors uppercase tracking-widest flex items-center">
                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        åˆªé™¤ç´€éŒ„
                                    </button>
                                </div>` : ''}
                            </div>
                        </div>
                    `;
                    container.innerHTML += card;
                });
            } catch (e) {
                console.error(e);
                container.innerHTML = '<div class="text-center col-span-full py-12 text-red-400">é€£ç·šç•°å¸¸ï¼Œè«‹é‡æ–°ç™»å…¥</div>';
            }
        }

        async function submitJob() {
            const video = document.getElementById('video-select').value;
            if (!video) return alert('è«‹é¸æ“‡å½±ç‰‡');

            const model = document.querySelector('input[name="model"]:checked').value;
            const btn = document.getElementById('btn-submit');
            const status = document.getElementById('status-msg');

            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3 inline" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> æäº¤ä»»å‹™ä¸­...';

            try {
                const res = await fetch('/api/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ video_name: video, model: model })
                });
                const data = await res.json();

                if (res.ok) {
                    status.className = 'mt-6 p-4 rounded-2xl text-center bg-green-50 text-green-700 border border-green-100 block';
                    status.textContent = `âœ… ${data.message}`;
                    setTimeout(() => { status.classList.add('hidden'); switchTab('library'); }, 2500);
                } else {
                    throw new Error(data.detail || 'æäº¤å¤±æ•—');
                }
            } catch (e) {
                status.className = 'mt-6 p-4 rounded-2xl text-center bg-red-50 text-red-700 border border-red-100 block';
                status.textContent = `âŒ ${e.message}`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'ğŸš€ é–‹å§‹ç”Ÿæˆæ•™æ';
            }
        }

        async function loadAdminData() {
            if (!isAdmin) return;
            loadQuizResults();
            loadAnnouncementsAdmin();
        }

        async function loadAnnouncementsAdmin() {
            const list = document.getElementById('announcement-admin-list');
            try {
                const res = await fetch('/'); // We get announcements from the main page context or a new API
                // For simplicity, since we rendered initial announcements via Jinja2,
                // we can either add an API GET /api/announcements or just use what we have.
                // Let's add a quick GET /api/announcements to app.py or fetch from current DOM if small.
                // Actually, let's just implement GET /api/announcements in app.py to be clean.
                const response = await fetch('/api/announcements');
                const anns = await response.json();
                list.innerHTML = anns.length ? '<h4 class="text-xs font-bold text-gray-400 uppercase mb-3">ç¾æœ‰å…¬å‘Š</h4>' : '';
                anns.forEach(a => {
                    list.innerHTML += `
                        <div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl border border-gray-100">
                            <p class="text-xs text-gray-600 truncate mr-4">${a.content}</p>
                            <button onclick="deleteAnnouncement(${a.id})" class="text-red-400 hover:text-red-600">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </div>
                    `;
                });
            } catch (e) {
                list.innerHTML = '<p class="text-xs text-gray-400">ç„¡æ³•åŠ è¼‰å…¬å‘Šåˆ—è¡¨</p>';
            }
        }

        async function deleteAnnouncement(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å…¬å‘Šå—ï¼Ÿ')) return;
            try {
                await fetch(`/api/announcements/${id}`, { method: 'DELETE' });
                loadAnnouncementsAdmin();
                alert('å…¬å‘Šå·²åˆªé™¤ï¼Œé‡æ–°æ•´ç†é é¢å¾Œç”Ÿæ•ˆ');
            } catch (e) { alert('åˆªé™¤å¤±æ•—'); }
        }

        async function loadQuizResults() {
            const list = document.getElementById('quiz-results-list');
            try {
                const res = await fetch('/api/quiz-results');
                const results = await res.json();
                list.innerHTML = results.length ? '' : '<tr><td colspan="4" class="px-6 py-12 text-center text-gray-400">ç›®å‰å°šç„¡æ¸¬é©—ç´€éŒ„</td></tr>';
                results.forEach(r => {
                    const date = new Date(r.created_at).toLocaleString();
                    const percent = Math.round((r.score / r.total_questions) * 100);
                    const colorClass = percent >= 80 ? 'text-green-600' : (percent >= 60 ? 'text-orange-500' : 'text-red-500');
                    list.innerHTML += `
                        <tr class="hover:bg-gray-50/50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-bold text-gray-900">${r.user_email}</div></td>
                            <td class="px-6 py-4 whitespace-nowrap"><div class="text-xs text-gray-500 max-w-[200px] truncate">${r.video_name}</div></td>
                            <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-bold ${colorClass}">${r.score} <span class="text-gray-300 font-normal">/</span> ${r.total_questions} <span class="text-[10px] ml-1 font-normal">(${percent}%)</span></div></td>
                            <td class="px-6 py-4 whitespace-nowrap text-[10px] text-gray-300">${date}</td>
                        </tr>
                    `;
                });
            } catch (e) { list.innerHTML = '<tr><td colspan="4" class="text-center text-red-400 py-8">è³‡æ–™åŠ è¼‰éŒ¯èª¤</td></tr>'; }
        }

        async function addAnnouncement() {
            const content = document.getElementById('announcement-content').value;
            if (!content.trim()) return;
            try {
                await fetch('/api/announcements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                document.getElementById('announcement-content').value = '';
                alert('å…¬å‘Šå·²ç™¼ä½ˆï¼Œé‡æ–°æ•´ç†å¾Œç”Ÿæ•ˆ');
                location.reload();
            } catch (e) { alert('ç™¼ä½ˆå¤±æ•—'); }
        }

        async function deleteReport(modelKey, videoName) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${videoName}ã€ç›¸é—œçš„æ‰€æœ‰åˆ†æè³‡æ–™å—ï¼Ÿ`)) return;
            try {
                const res = await fetch(`/api/reports/${modelKey}/${encodeURIComponent(videoName)}`, { method: 'DELETE' });
                const data = await res.json();
                alert(data.message);
                loadReports();
            } catch (e) { alert('åˆªé™¤å¤±æ•—'); }
        }

        function setupUpload() {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            dropZone.onclick = () => fileInput.click();
            fileInput.onchange = () => uploadFile(fileInput.files[0]);
        }

        async function uploadFile(file) {
            if (!file) return;
            const formData = new FormData();
            formData.append('file', file);
            document.getElementById('upload-progress').classList.remove('hidden');
            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                if (res.ok) { await loadVideos(); } else { alert('ä¸Šå‚³å¤±æ•—'); }
            } catch (e) { alert('ä¸Šå‚³å‡ºéŒ¯'); }
            finally { document.getElementById('upload-progress').classList.add('hidden'); }
        }

        async function loadVideos() {
            const select = document.getElementById('video-select');
            try {
                const res = await fetch('/api/videos');
                const videos = await res.json();
                select.innerHTML = videos.length ? '' : '<option value="">ç„¡å¯ç”¨å½±ç‰‡</option>';
                videos.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v; opt.textContent = v;
                    select.appendChild(opt);
                });
            } catch (e) { select.innerHTML = '<option value="">è¼‰å…¥å¤±æ•—</option>'; }
        }
    </script>
</body>

</html>